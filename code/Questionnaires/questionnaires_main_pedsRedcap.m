%% Questionnaire organization
% Analysis code for the Penn Online Evaluation of Migraine (POEM) adapted
% for children and adolescents, and run for data collected through CHOP redcap
%
% Description:
%   This routine loads the .csv files generated by Redcap that have the
%   results of the migraine diagnostic pathway.
%
%   Subsequent functions called from this main script are responsible for
%   pre-processing of the data fields and then implementing the headache
%   classification pathway.
%

%% Housekeeping
clear variables
close all

addpath '/Users/pattersonc/Documents/MATLAB/commonFx'

%% Set paths to data and output
dataDir = '/Users/pattersonc/OneDrive - Children''s Hospital of Philadelphia/Research/Minds Matter/Data/HAsubstudy/Forms/';
analysisDir = '/Users/pattersonc/OneDrive - Children''s Hospital of Philadelphia/Research/Minds Matter/analysis/HAsubstudy/Forms/';

% Set the output filenames
outputResultExcelName = fullfile(analysisDir, 'POEMpeds_v2.3_results.xlsx');
rawDataSheets = {'HeadacheSubstudy-PrelimDataAnalysisCP_DATA_LABELS_2025-03-04_1951.csv'};
rawDataSheets2 = {'HeadacheSubstudy-DemographicsAndIntak_DATA_LABELS_2025-03-10_1300.csv'};

% get the full path to thisDataSheet
thisDataSheetFileName = fullfile(dataDir, rawDataSheets{1});
thatDataSheetFileName = fullfile(dataDir, rawDataSheets2{1});


%% Organize and analyze POEM results
[POEM] = poemAnalysis_preProcess_redcap(thisDataSheetFileName);

% classify headache based upon table T
diagnosisTable = poemAnalysis_classify_redcap2(POEM);
writetable(diagnosisTable,outputResultExcelName,'Range','A4','WriteRowNames',true)

%% Organize headache questions
[HA,MEDS,PCSI] = headacheQ_preProcess_redcap(thisDataSheetFileName);

%% Organize headache questions
[DEMO] = demoIntake_preProcess_redcap(thatDataSheetFileName);

%% Determine diagnosis categories
DxCat = Dx_categories(HA,PCSI);

%% Calculate CAMS
analysis_pathCAMS = getpref('assocSxHA','assocSxHaAnalysisPath');
load([analysis_pathCAMS '/CAMS_ChopAll_May2024.mat'],'CAMS','Chop_mdl')

var_HAaSx = CAMS.var_pres;

haASx = [HA.othSx_nausea HA.othSx_vomiting HA.othSx_lightsens HA.othSx_soundsens...
    HA.othSx_smellsens HA.othSx_lighthead HA.othSx_spinning HA.othSx_balance... 
    HA.othSx_thinking HA.vis_blurred HA.vis_double HA.othSx_ringing HA.othSx_neckpain];

binary_hx = cell(size(haASx));
binary_struct = NaN*ones(size(haASx,2),1);
for x = 1:size(haASx,2)
    temp = haASx(:,x);
    outcome = unique(temp);
        for y = 1:size(haASx,1)
            binary_struct(x,:) = 2;
                switch temp(y)
                    case outcome(1)
                        binary_hx{y,x} = [1 0];
                    case outcome(2)
                        binary_hx{y,x} = [0 1];
                end
        end
end

% concatonate each subjects binary outcomes
binary_Hx = NaN*ones(size(binary_hx,1),size(var_HAaSx,1)*2);
temp = [];
for x = 1:size(binary_hx,1)
    for y = 1:size(binary_hx,2)
        temp = cat(2,temp,cell2mat(binary_hx(x,y)));
    end
    binary_Hx(x,:) = temp;
    temp = [];
end

CAMS_model = CAMS.MCA_model;

% Calculate CAMS scores
MCA_no=3;
MCA_score_HAaSx = NaN*ones(size(binary_Hx,1),MCA_no);
for x = 1:size(binary_Hx,1)
    for y = 1:MCA_no
        temp1 = binary_Hx(x,:);
        temp2 = CAMS_model(:,y);
        r=temp1*temp2;
        MCA_score_HAaSx(x,y) = r;
    end
end

HA.CAMS1_T1 = 1*MCA_score_HAaSx(:,1);
HA.CAMS2_T1 = 1*MCA_score_HAaSx(:,2);
HA.CAMS3_T1 = -1*MCA_score_HAaSx(:,3);

CAMS = runCAMS(Chop_mdl(:,16:28),CAMS.var_pres,CAMS.var_abs,'MCA_no',8,'xColor',0.6,'xBubble',80,'Sn',[1 1 -1]);
hold on
plot(mean(HA.CAMS1_T1),mean(HA.CAMS2_T1),'ok')

clear MCA* temp* x y r binary* haASx

%% determine percentage reporting different headache triggers and headache-associated symptoms
figure
bar(1:13,[length(HA.othSx_nausea(HA.othSx_nausea=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_vomiting(HA.othSx_vomiting=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_lightsens(HA.othSx_lightsens=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_soundsens(HA.othSx_soundsens=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_smellsens(HA.othSx_smellsens=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_lighthead(HA.othSx_lighthead=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_spinning(HA.othSx_spinning=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_balance(HA.othSx_balance=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_thinking(HA.othSx_thinking=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.vis_blurred(HA.vis_blurred=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.vis_double(HA.vis_double=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_ringing(HA.othSx_ringing=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_neckpain(HA.othSx_neckpain=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache'))])
ax=gca; ax.TickDir='out'; ax.Box='off'; ax.XTick = 1:13; ax.XTickLabel = var_HAaSx;



figure
bar(1:18,[length(HA.othSx_nausea(HA.trig_menses=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_vomiting(HA.trig_sleepmore=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_lightsens(HA.trig_sleepless=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_soundsens(HA.trig_fatigue=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_smellsens(HA.trig_exercise=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_lighthead(HA.trig_overheat=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_spinning(HA.trig_dehydrate=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_balance(HA.trig_skipmeal=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_thinking(HA.trig_foods=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.vis_blurred(HA.trig_meds=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.vis_double(HA.trig_chew=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_ringing(HA.trig_stress=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_ringing(HA.trig_screen=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_ringing(HA.trig_reading=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_ringing(HA.trig_light=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_ringing(HA.trig_noise=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_ringing(HA.trig_smoking=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache')) ...
    length(HA.othSx_neckpain(HA.trig_weather=='Checked'))./length(DxCat.HeadacheT1(DxCat.HeadacheT1=='headache'))])
ax=gca; ax.TickDir='out'; ax.Box='off'; ax.XTick = 1:18; 
ax.XTickLabel = {'menses','sleep more','sleep less','fatigue','exercise','overheat','dehydrate',...
    'skip meals','foods','meds','chewing','stress','screen','reading','light','noise','smoking','weather'};